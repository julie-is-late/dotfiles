#!/bin/zsh
# sync file changes in $1 directory to $2 host.
# this is super jank

dir1=${1} && shift
dir2=${1} && shift
host=${1} && shift

echo "\`:cq\` to halt xargs"

rsync -nvrca ${dir1}/ ${host}:${dir2// /\\ }/ $@ | \
    head -n-3 | \
    tail -n+2 | \
    grep -v -E "/$" | \
    grep -v -E "^created directory " | \
    xargs -i --interactive -- bash -c "</dev/tty vimdiff '${dir1}/{}' 'rsync://${host}/${dir2// /\\ }/{}' || exit 255"

rsync -nvrca --ignore-existing ${host}:${dir2// /\\ }/ ${dir1}/ $@ | \
    head -n-3 | \
    tail -n+2 | \
    grep -v -E "/$" | \
    grep -v -E "^created directory " | \
    xargs -i --interactive -- bash -c "</dev/tty vimdiff 'rsync://${host}/${dir2// /\\ }/{}' '${dir1}/{}' || exit 255"
